{% for public_hostname, containers in virtual_hosts.items() -%}

upstream {{ public_hostname }} {
    {%- for us_host in containers %}
    server {{ us_host.attrs.NetworkSettings.IPAddress }}:8080;
    {%- endfor %}
}

server {
    server_name {{ public_hostname }};
    listen 80;

    location ~ /\.well-known/.* {
        root /usr/share/nginx/html;
        index index.html index.htm;
    }


{% if https_conf[public_hostname] -%}

    location ~ /.* {
        proxy_pass http://{{ public_hostname }};
    }

    listen 443 ssl;

    ssl_certificate /etc/letsencrypt/live/{{ public_hostname }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{{ public_hostname }}/privkey.pem;

    if ($scheme != "https") { 
        return 301 https://$host$request_uri; 
    }

    ssl_session_cache shared:le_nginx_SSL:10m;
    ssl_session_timeout 1440m;

    ssl_protocols TLSv1.2;
    ssl_prefer_server_ciphers on;
    ssl_stapling on; # speeds up revocation checking by caching it on the server
    ssl_stapling_verify on;

    # # The following should be used with caution:
    # add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";
    # add_header X-Frame-Options DENY;
    # add_header X-Content-Type-Options nosniff;

    ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";
    ssl_ecdh_curve secp384r1;
{% endif -%}
}
{%- endfor %}

